### ====================================================================
### Lab 6 - Testy autoryzacji zgodnie z wymaganiami
### ====================================================================
### Wymagania:
### 1. Tylko administrator może dodawać i usuwać kategorie (figures)
### 2. Zwykły użytkownik może pobierać wszystkie kategorie
### 3. Każdy nowy użytkownik może się zarejestrować
### 4. Administrator może pobrać wszystkie elementy (notes)
### 5. Zwykły użytkownik może pobrać tylko swoje elementy
### 6. Administrator może edytować i usuwać wszystkie elementy
### 7. Zwykły użytkownik może edytować i usuwać tylko swoje elementy
### 8. Zwykły użytkownik może dodawać elementy (owner ustawiany automatycznie)
### ====================================================================

@base = http://localhost:9080/historyapi/api
@figureIdNapoleon = 15a7f9a0-7ac1-11eb-8000-0242ac110002
@figureIdCurie = 15a7fae0-7ac1-11eb-8001-0242ac110002
@noteIdNapoleon = 25b8c1f0-7ac1-11eb-8000-0242ac110002
@noteIdCurie = 25b8c3a0-7ac1-11eb-8001-0242ac110002
@newFigureId = 00000000-0000-0000-0000-000000000000
@newNoteId = 00000000-0000-0000-0000-000000000000

### ====================================================================
### WYMAGANIE 3: Każdy nowy użytkownik może się zarejestrować
### ====================================================================

### ✅ [3.1] Rejestracja bez autoryzacji - POWINNO ZADZIAŁAĆ (201)
# @no-cookie-jar
POST {{base}}/users
Content-Type: application/json

{
  "login": "newuser123",
  "email": "newuser123@example.com",
  "password": "SecurePass123"
}

### ✅ [3.2] Sprawdź, że użytkownik został dodany - ADMIN pobiera listę
# @no-cookie-jar
GET {{base}}/users
Authorization: Basic admin admin123

### ====================================================================
### WYMAGANIE 1: Tylko administrator może dodawać kategorie (figures)
### ====================================================================

### ❌ [1.1] USER próbuje dodać kategorię - POWINNO ZWRÓCIĆ 403 Forbidden
# @no-cookie-jar
POST {{base}}/figures/
Content-Type: application/json
Authorization: Basic test password123

{
  "name": "Testowa Postac USER",
  "dateOfBrith": "1900-01-01",
  "dateOfDeath": "1980-01-01"
}

### ✅ [1.2] ADMIN dodaje kategorię - POWINNO ZWRÓCIĆ 201 Created
# @name createFigure
# @no-cookie-jar
POST {{base}}/figures/
Content-Type: application/json
Authorization: Basic admin admin123

{
  "name": "Albert Einstein",
  "dateOfBrith": "1879-03-14",
  "dateOfDeath": "1955-04-18"
}

### Zapisz ID nowo utworzonej postaci (skopiuj z Location header)
@newFigureId = {{createFigure.response.headers.Location}}

### ====================================================================
### WYMAGANIE 2: Zwykły użytkownik może pobierać wszystkie kategorie
### ====================================================================

### ✅ [2.1] USER pobiera wszystkie kategorie - POWINNO ZADZIAŁAĆ (200)
# @no-cookie-jar
GET {{base}}/figures/
Accept: application/json
Authorization: Basic test password123

### ✅ [2.2] ADMIN też może pobrać wszystkie kategorie - POWINNO ZADZIAŁAĆ (200)
# @no-cookie-jar
GET {{base}}/figures/
Accept: application/json
Authorization: Basic admin admin123

### ❌ [2.3] Niezalogowany użytkownik próbuje pobrać kategorie - POWINNO ZWRÓCIĆ 401
# @no-cookie-jar
GET {{base}}/figures/
Accept: application/json

### ====================================================================
### WYMAGANIE 8: Zwykły użytkownik może dodawać elementy (notes)
### Owner ustawiany automatycznie na poziomie logiki biznesowej
### ====================================================================

### ✅ [8.1] USER dodaje notatkę do Napoleona - POWINNO ZADZIAŁAĆ (201)
# @name createNoteByUser
# @no-cookie-jar
POST {{base}}/figures/{{figureIdNapoleon}}/notes
Content-Type: application/json
Authorization: Basic test password123

{
  "title": "Moja notatka o Napoleonie",
  "content": "Napoleon byl wielkim dowodca.",
  "mode": "PUBLIC"
}

### ✅ [8.2] ADMIN dodaje notatkę do Curie - POWINNO ZADZIAŁAĆ (201)
# @name createNoteByAdmin
# @no-cookie-jar
POST {{base}}/figures/{{figureIdCurie}}/notes
Content-Type: application/json
Authorization: Basic admin admin123

{
  "title": "Notatka admina o Curie",
  "content": "Maria Sklodowska-Curie odkryla rad i polon.",
  "mode": "PUBLIC"
}

### ====================================================================
### WYMAGANIE 5: Zwykły użytkownik może pobrać tylko swoje elementy
### (filtrowanie na poziomie bazy danych)
### ====================================================================

### ✅ [5.1] USER pobiera notatki do Napoleona - widzi TYLKO SWOJE
# @no-cookie-jar
GET {{base}}/figures/{{figureIdNapoleon}}/notes
Accept: application/json
Authorization: Basic test password123

### ✅ [5.2] USER pobiera notatki do Curie - widzi TYLKO SWOJE (może być pusta lista)
# @no-cookie-jar
GET {{base}}/figures/{{figureIdCurie}}/notes
Accept: application/json
Authorization: Basic test password123

### ====================================================================
### WYMAGANIE 4: Administrator może pobrać wszystkie elementy
### ====================================================================

### ✅ [4.1] ADMIN pobiera wszystkie notatki Napoleona - widzi WSZYSTKIE
# @no-cookie-jar
GET {{base}}/figures/{{figureIdNapoleon}}/notes
Accept: application/json
Authorization: Basic admin admin123

### ✅ [4.2] ADMIN pobiera wszystkie notatki Curie - widzi WSZYSTKIE
# @no-cookie-jar
GET {{base}}/figures/{{figureIdCurie}}/notes
Accept: application/json
Authorization: Basic admin admin123

### ✅ [4.3] ADMIN pobiera wszystkie notatki (endpoint globalny)
# @no-cookie-jar
GET {{base}}/notes
Accept: application/json
Authorization: Basic admin admin123

### ====================================================================
### WYMAGANIE 7: Zwykły użytkownik może edytować tylko swoje elementy
### ====================================================================

### ✅ [7.1] USER edytuje swoją notatkę - POWINNO ZADZIAŁAĆ (200)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdNapoleon}}/notes/{{noteIdNapoleon}}
Content-Type: application/json
Authorization: Basic test password123

{
  "title": "Zaktualizowana notatka USER",
  "content": "Napoleon byl cesarzem Francji.",
  "mode": "PRIVATE"
}

### ❌ [7.2] USER próbuje edytować notatkę admina - POWINNO ZWRÓCIĆ 403 Forbidden
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Content-Type: application/json
Authorization: Basic test password123

{
  "title": "Proba hakowania notatki admina",
  "content": "To nie powinno sie udac",
  "mode": "PUBLIC"
}

### ====================================================================
### WYMAGANIE 6: Administrator może edytować wszystkie elementy
### ====================================================================

### ✅ [6.1] ADMIN edytuje notatkę USER - POWINNO ZADZIAŁAĆ (200)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdNapoleon}}/notes/{{noteIdNapoleon}}
Content-Type: application/json
Authorization: Basic admin admin123

{
  "title": "Admin edytuje notatke USER",
  "content": "Admin moze edytowac wszystkie notatki.",
  "mode": "PUBLIC"
}

### ✅ [6.2] ADMIN edytuje swoją notatkę - POWINNO ZADZIAŁAĆ (200)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Content-Type: application/json
Authorization: Basic admin admin123

{
  "title": "Admin edytuje swoja notatke",
  "content": "Curie otrzymala dwie nagrody Nobla.",
  "mode": "PUBLIC"
}

### ✅ [6.3] ADMIN edytuje kategorię (figure) - POWINNO ZADZIAŁAĆ (200)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdNapoleon}}
Content-Type: application/json
Authorization: Basic admin admin123

{
  "name": "Napoleon Bonaparte (zaktualizowany)",
  "dateOfBrith": "1769-08-15",
  "dateOfDeath": "1821-05-05"
}

### ❌ [6.4] USER próbuje edytować kategorię - POWINNO ZWRÓCIĆ 403 Forbidden
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdNapoleon}}
Content-Type: application/json
Authorization: Basic test password123

{
  "name": "USER nie moze tego edytowac",
  "dateOfBrith": "1769-08-15",
  "dateOfDeath": "1821-05-05"
}

### ====================================================================
### WYMAGANIE 7: Zwykły użytkownik może usuwać tylko swoje elementy
### ====================================================================

### ❌ [7.3] USER próbuje usunąć notatkę admina - POWINNO ZWRÓCIĆ 403 Forbidden
# @no-cookie-jar
DELETE {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Authorization: Basic test password123

### ✅ [7.4] USER usuwa swoją notatkę - POWINNO ZADZIAŁAĆ (204)
# @no-cookie-jar
DELETE {{base}}/figures/{{figureIdNapoleon}}/notes/{{noteIdNapoleon}}
Authorization: Basic test password123

### ====================================================================
### WYMAGANIE 6: Administrator może usuwać wszystkie elementy
### ====================================================================

### ✅ [6.5] ADMIN usuwa notatkę - POWINNO ZADZIAŁAĆ (204)
# @no-cookie-jar
DELETE {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Authorization: Basic admin admin123

### ====================================================================
### WYMAGANIE 1: Tylko administrator może usuwać kategorie
### ====================================================================

### ❌ [1.3] USER próbuje usunąć kategorię - POWINNO ZWRÓCIĆ 403 Forbidden
# @no-cookie-jar
DELETE {{base}}/figures/{{figureIdNapoleon}}
Authorization: Basic test password123

### ✅ [1.4] ADMIN usuwa kategorię - POWINNO ZADZIAŁAĆ (204)
# Uwaga: to usunie również wszystkie powiązane notatki (cascade delete)
# @no-cookie-jar
DELETE {{base}}/figures/{{newFigureId}}
Authorization: Basic admin admin123

### ====================================================================
### DODATKOWE TESTY - weryfikacja bezpieczeństwa
### ====================================================================

### ❌ Próba dostępu bez autoryzacji do chronionych zasobów
# @no-cookie-jar
GET {{base}}/notes
Accept: application/json

### ❌ Próba dostępu z nieprawidłowymi danymi
# @no-cookie-jar
GET {{base}}/figures/
Authorization: Basic wronguser wrongpassword

### ✅ Sprawdzenie, że avatary działają dla zalogowanych użytkowników
# @no-cookie-jar
GET {{base}}/users/fe003ce8-0dae-46cb-8d01-104d1d91d4a0/avatar
Accept: image/png, image/jpeg
Authorization: Basic test password123

### ====================================================================
### PODSUMOWANIE TESTÓW
### ====================================================================
### Test authorization matrix:
###
### | Akcja                    | ADMIN | USER | Niezalogowany |
### |--------------------------|-------|------|---------------|
### | Rejestracja              |  ✅   |  ✅  |      ✅       |
### | Pobierz kategorie        |  ✅   |  ✅  |      ❌       |
### | Dodaj kategorię          |  ✅   |  ❌  |      ❌       |
### | Edytuj kategorię         |  ✅   |  ❌  |      ❌       |
### | Usuń kategorię           |  ✅   |  ❌  |      ❌       |
### | Pobierz wszystkie notes  |  ✅   |tylko swoje|  ❌   |
### | Dodaj note               |  ✅   |  ✅  |      ❌       |
### | Edytuj swój note         |  ✅   |  ✅  |      ❌       |
### | Edytuj cudzy note        |  ✅   |  ❌  |      ❌       |
### | Usuń swój note           |  ✅   |  ✅  |      ❌       |
### | Usuń cudzy note          |  ✅   |  ❌  |      ❌       |
### ====================================================================

