### ===============================================================
### LAB 6 - COMPLETE TEST SUITE (Cause & Effect chains)
### Testy sprawdzające autoryzację krok po kroku
### ===============================================================

@base = http://localhost:9080/historyapi/api
@figureIdNapoleon = 15a7f9a0-7ac1-11eb-8000-0242ac110002
@figureIdCurie = 15a7fae0-7ac1-11eb-8001-0242ac110002
@noteIdCurie = 25b8c3a0-7ac1-11eb-8001-0242ac110002
@adminId = fe003ce8-0dae-46cb-8d01-104d1d91d4a0

### ===============================================================
### 1. REJESTRACJA - każdy może się zarejestrować (PermitAll)
### ===============================================================

### ✅ [1.1] Rejestracja nowego użytkownika - BEZ AUTORYZACJI (powinno zadziałać)
# @no-cookie-jar
POST {{base}}/users
Content-Type: application/json

{
  "login": "newuser",
  "email": "newuser@example.com",
  "password": "password123"
}

###
### ✅ [1.2] Pobierz wszystkich użytkowników jako ADMIN - sprawdzenie czy newuser został dodany
# @no-cookie-jar
GET {{base}}/users
Accept: application/json
Authorization: Basic admin admin123

###
### ❌ [1.3] Pobierz wszystkich użytkowników jako USER - powinno być FORBIDDEN (403)
# @no-cookie-jar
GET {{base}}/users
Accept: application/json
Authorization: Basic test password123

### ===============================================================
### 2. KATEGORIE (Historical Figures) - tylko ADMIN może dodawać/usuwać
### ===============================================================

### ✅ [2.1] Pobierz wszystkie kategorie jako USER (powinno zadziałać - PermitAll)
# @no-cookie-jar
GET {{base}}/figures/
Accept: application/json
Authorization: Basic test password123

###
### ✅ [2.2] Pobierz wszystkie kategorie jako ADMIN (też powinno zadziałać)
# @no-cookie-jar
GET {{base}}/figures/
Accept: application/json
Authorization: Basic admin admin123


###
### ✅ [2.3] ADMIN dodaje nową kategorię (powinno zadziałać - 201 Created)
# @no-cookie-jar
POST {{base}}/figures/
Content-Type: application/json
Authorization: Basic admin admin123

{
  "name": "Albert Einstein",
  "dateOfBrith": "1879-03-14",
  "dateOfDeath": "1955-04-18"
}

###
### ✅ [2.4] Pobierz kategorie ponownie - sprawdzenie czy Einstein został dodany
# @no-cookie-jar
GET {{base}}/figures/
Accept: application/json
Authorization: Basic admin admin123

###
### ❌ [2.5] USER próbuje dodać kategorię (powinno być FORBIDDEN - 403)
# @no-cookie-jar
POST {{base}}/figures/
Content-Type: application/json
Authorization: Basic test password123

{
  "name": "Isaac Newton",
  "dateOfBrith": "1643-01-04",
  "dateOfDeath": "1727-03-31"
}

###
### ✅ [2.6] ADMIN modyfikuje kategorię (powinno zadziałać - 200 OK)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdNapoleon}}
Content-Type: application/json
Authorization: Basic admin admin123

{
  "name": "Napoleon Bonaparte - ZMODYFIKOWANY",
  "dateOfBrith": "1769-08-15",
  "dateOfDeath": "1821-05-05"
}

###
### ✅ [2.7] Sprawdzenie czy modyfikacja się zapisała
# @no-cookie-jar
GET {{base}}/figures/{{figureIdNapoleon}}
Accept: application/json
Authorization: Basic test password123

###
### ❌ [2.8] USER próbuje zmodyfikować kategorię (powinno być FORBIDDEN - 403)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdCurie}}
Content-Type: application/json
Authorization: Basic test password123

{
  "name": "Maria Curie - HACK ATTEMPT"
}

###
### ✅ [2.9] ADMIN usuwa kategorię (powinno zadziałać - 204 No Content)
# @no-cookie-jar
DELETE {{base}}/figures/{{figureIdNapoleon}}
Authorization: Basic admin admin123

###
### ✅ [2.10] Sprawdzenie czy kategoria została usunięta (powinno być 404)
# @no-cookie-jar
GET {{base}}/figures/{{figureIdNapoleon}}
Accept: application/json
Authorization: Basic admin admin123

###
### ❌ [2.11] USER próbuje usunąć kategorię (powinno być FORBIDDEN - 403)
# @no-cookie-jar
DELETE {{base}}/figures/{{figureIdCurie}}
Authorization: Basic test password123

### ===============================================================
### 3. NOTATKI - właściciel ustawiany automatycznie
### ===============================================================

### ✅ [3.1] USER dodaje notatkę - właściciel ustawiany automatycznie (201 Created)
# @no-cookie-jar
POST {{base}}/figures/{{figureIdCurie}}/notes
Content-Type: application/json
Authorization: Basic test password123

{
  "title": "Notatka użytkownika TEST",
  "content": "Automatycznie przypisana do użytkownika test.",
  "mode": "PRIVATE"
}

###
### ✅ [3.2] ADMIN pobiera wszystkie notatki (powinno zwrócić WSZYSTKIE)
# @no-cookie-jar
GET {{base}}/notes
Accept: application/json
Authorization: Basic admin admin123

###
### ✅ [3.3] USER pobiera swoje notatki (filtrowanie DB - tylko swoje)
# @no-cookie-jar
GET {{base}}/notes
Accept: application/json
Authorization: Basic test password123

###
### ✅ [3.4] Inny USER (olaf) pobiera swoje notatki (powinno zwrócić tylko jego)
# @no-cookie-jar
GET {{base}}/notes
Accept: application/json
Authorization: Basic olaf password123

###
### ✅ [3.5] USER (test) modyfikuje swoją notatkę (powinno zadziałać - 200 OK)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Content-Type: application/json
Authorization: Basic test password123

{
  "title": "Notatka ZMODYFIKOWANA przez test",
  "content": "Zmieniona treść.",
  "mode": "PUBLIC"
}

###
### ❌ [3.6] Inny USER (olaf) próbuje zmodyfikować cudzą notatkę (403 Forbidden)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Content-Type: application/json
Authorization: Basic olaf password123

{
  "title": "HACK ATTEMPT - olaf próbuje zmienić notatkę test"
}

###
### ✅ [3.7] ADMIN może modyfikować wszystkie notatki (200 OK)
# @no-cookie-jar
PUT {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Content-Type: application/json
Authorization: Basic admin admin123

{
  "title": "Notatka zmodyfikowana przez ADMIN",
  "content": "Admin może edytować wszystkie.",
  "mode": "PUBLIC"
}

###
### ✅ [3.8] Sprawdzenie czy modyfikacja się zapisała
# @no-cookie-jar
GET {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Accept: application/json
Authorization: Basic test password123

###
### ✅ [3.9] ADMIN usuwa notatkę (204 No Content)
# @no-cookie-jar
DELETE {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Authorization: Basic admin admin123

###
### ✅ [3.10] Sprawdzenie czy notatka została usunięta (404 Not Found)
# @no-cookie-jar
GET {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Accept: application/json
Authorization: Basic admin admin123

###
### ❌ [3.11] USER próbuje usunąć cudzą notatkę (403 Forbidden)
# Najpierw dodajmy notatkę admina
# @no-cookie-jar
POST {{base}}/figures/{{figureIdCurie}}/notes
Content-Type: application/json
Authorization: Basic admin admin123

{
  "title": "Notatka ADMINA",
  "content": "Tylko admin powinien móc ją usunąć.",
  "mode": "PUBLIC"
}

###
### ❌ [3.12] USER (test) próbuje usunąć notatkę admina (403 Forbidden)
# Pobierz ID z poprzedniej odpowiedzi i podstaw tutaj
# @no-cookie-jar
DELETE {{base}}/notes/9243492e-be41-42e2-8d6d-155ac665b549
Authorization: Basic test password123

### ===============================================================
### 4. AVATARY - zalogowani użytkownicy mogą zarządzać
### ===============================================================

### ✅ [4.1] USER uploaduje swój avatar (201 Created)
# @no-cookie-jar
POST {{base}}/users/{{adminId}}/avatar
Content-Type: image/jpeg
Authorization: Basic admin admin123

< ./src/main/resources/avatars/1.jpg

###
### ✅ [4.2] Pobierz avatar (200 OK z obrazem)
# @no-cookie-jar
GET {{base}}/users/{{adminId}}/avatar
Accept: image/png, image/jpeg
Authorization: Basic admin admin123

###
### ✅ [4.3] USER usuwa swój avatar (200 OK)
# @no-cookie-jar
DELETE {{base}}/users/{{adminId}}/avatar
Authorization: Basic admin admin123

###
### ❌ [4.4] Upload nieobsługiwanego formatu (400 Bad Request)
# @no-cookie-jar
POST {{base}}/users/{{adminId}}/avatar
Content-Type: image/gif
Authorization: Basic admin admin123

< ./src/main/resources/avatars/1.jpg

### ===============================================================
### 5. TESTY NEGATYWNE - brak autoryzacji
### UWAGA: Testy usuwania użytkownika - ADMIN usuwa 'newuser', NIE SIEBIE!
### (w przeciwnym razie kolejne testy z admin będą zwracać 401)
### ===============================================================

### ❌ [5.1] Dostęp bez autoryzacji do chronionych zasobów (401 Unauthorized)
# @no-cookie-jar
GET {{base}}/notes
Accept: application/json

###
### ❌ [5.2] Próba dodania kategorii bez autoryzacji (401)
# @no-cookie-jar
POST {{base}}/figures/
Content-Type: application/json

{
  "name": "Unauthorized Attempt"
}

###
### ✅ [5.3] ADMIN pobiera listę użytkowników - znajdź ID 'newuser'
# @no-cookie-jar
GET {{base}}/users
Accept: application/json
Authorization: Basic admin admin123

###
### ❌ [5.4] Próba usunięcia użytkownika jako USER (403 Forbidden - tylko ADMIN)
# Użyj ID 'newuser' z poprzedniej odpowiedzi
# @no-cookie-jar
DELETE {{base}}/users/{newuser-id-here}
Authorization: Basic test password123

###
### ✅ [5.5] ADMIN może usunąć użytkownika 'newuser' (204 No Content)
# Użyj tego samego ID 'newuser' z testu 5.3
# @no-cookie-jar
DELETE {{base}}/users/{newuser-id-here}
Authorization: Basic admin admin123

### ===============================================================
### 6. PODSUMOWANIE - Sprawdzenie końcowego stanu
### ===============================================================

### ✅ [6.1] Lista wszystkich kategorii (ADMIN)
# @no-cookie-jar
GET {{base}}/figures/
Accept: application/json
Authorization: Basic admin admin123

###
### ✅ [6.2] Lista wszystkich notatek (ADMIN)
# @no-cookie-jar
GET {{base}}/notes
Accept: application/json
Authorization: Basic admin admin123

###
### ✅ [6.3] Lista notatek użytkownika test (tylko jego)
# @no-cookie-jar
GET {{base}}/notes
Accept: application/json
Authorization: Basic test password123

###
### ✅ [6.4] Lista wszystkich użytkowników (ADMIN)
# @no-cookie-jar
GET {{base}}/users
Accept: application/json
Authorization: Basic admin admin123

### ===============================================================
### KONIEC TESTÓW - wszystkie wymagania Lab 6 sprawdzone ✅
### ===============================================================

