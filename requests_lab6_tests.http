### Lab6 - Functional tests for REST endpoints (figures, notes, users, avatars)
# Base URL used in tests
@base = http://localhost:9080/historyapi/api

# Known IDs from your test dataset (adjust if needed)
@figureIdNapoleon = 15a7f9a0-7ac1-11eb-8000-0242ac110002
@figureIdCurie = 15a7fae0-7ac1-11eb-8001-0242ac110002
@noteIdNapoleon = 25b8c1f0-7ac1-11eb-8000-0242ac110002
@noteIdCurie = 25b8c3a0-7ac1-11eb-8001-0242ac110002
@testUserId = fe003ce8-0dae-46cb-8d01-104d1d91d4a0
@uuidNotFound = 11111111-1111-1111-1111-111111111111


### ===============================================================
### Figures (categories) - authorization and CRUD
### ===============================================================

# GET all figures - should be allowed for authenticated users
GET {{base}}/figures/
Accept: application/json
Authorization: Basic test password123

# GET single figure - should return 200
GET {{base}}/figures/{{figureIdNapoleon}}
Accept: application/json
Authorization: Basic test password123

# GET non-existing figure - should return 404
GET {{base}}/figures/{{uuidNotFound}}
Accept: application/json
Authorization: Basic test password123

# TRY create figure as USER - should be 403 (only ADMIN allowed)
POST {{base}}/figures/
Content-Type: application/json
Authorization: Basic test password123

{
  "name": "Albert Einstein",
  "dateOfBrith": "1879-03-14",
  "dateOfDeath": "1955-04-18"
}

# Create figure as ADMIN - should return 201 Created
POST {{base}}/figures/
Content-Type: application/json
Authorization: Basic admin admin123

{
  "name": "Albert Einstein",
  "dateOfBrith": "1879-03-14",
  "dateOfDeath": "1955-04-18"
}

# Modify figure as ADMIN
PUT {{base}}/figures/{{figureIdNapoleon}}
Content-Type: application/json
Authorization: Basic admin admin123

{
  "name": "Napoleon Bonaparte ZMODYFIKOWANY",
  "dateOfBrith": "1769-08-15",
  "dateOfDeath": "1821-05-05"
}

# Delete figure as ADMIN (and its notes) - expect 204
DELETE {{base}}/figures/{{figureIdNapoleon}}
Authorization: Basic admin admin123

### ===============================================================
### Notes (hierarchical) - per-figure ownership rules
### ===============================================================

# Admin: list all notes for a figure
GET {{base}}/figures/{{figureIdCurie}}/notes
Accept: application/json
Authorization: Basic admin admin123

# User: list notes for a figure (should return only user's notes)
GET {{base}}/figures/{{figureIdCurie}}/notes
Accept: application/json
Authorization: Basic test password123

# Get single note (as USER) - should return 200 if owner or 403 otherwise
GET {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Accept: application/json
Authorization: Basic test password123

# Create a new note as USER - owner should be set automatically to authenticated user
POST {{base}}/figures/{{figureIdCurie}}/notes
Content-Type: application/json
Authorization: Basic test password123

{
  "title": "Nowa notatka o Radzie",
  "content": "Odkryła rad i polon.",
  "mode": "PUBLIC"
}

# Modify note as USER (own note) - expect 200
PUT {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Content-Type: application/json
Authorization: Basic test password123

{
  "title": "ZMODYFIKOWANA Notatka o Marii",
  "content": "Zupełnie nowa treść.",
  "mode": "PRIVATE"
}

# Delete note as ADMIN - should return 204
DELETE {{base}}/figures/{{figureIdCurie}}/notes/{{noteIdCurie}}
Authorization: Basic admin admin123

### ===============================================================
### Notes (non-hierarchical) - global endpoints
### ===============================================================

# Get note by id (global)
GET {{base}}/notes/{{noteIdCurie}}
Accept: application/json
Authorization: Basic test password123

# Get all notes (USER -> only own notes)
GET {{base}}/notes
Accept: application/json
Authorization: Basic test password123

# Get all notes (ADMIN -> all notes)
GET {{base}}/notes
Accept: application/json
Authorization: Basic admin admin123

# Delete note (global) as USER - should return 403 if not owner
DELETE {{base}}/notes/{{noteIdCurie}}
Authorization: Basic test password123

### ===============================================================
### Users - registration, admin operations
### ===============================================================

# GET all users - only ADMIN
GET {{base}}/users
Accept: application/json
Authorization: Basic admin admin123

# GET single user - only ADMIN
GET {{base}}/users/{{testUserId}}
Accept: application/json
Authorization: Basic admin admin123

# Register new user (PermitAll) - should return 201
POST {{base}}/users
Content-Type: application/json

{
  "login": "newuser",
  "email": "newuser@example.com",
  "password": "password123"
}

# Register duplicate user - expect 409 Conflict
POST {{base}}/users
Content-Type: application/json

{
  "login": "test",
  "email": "another@example.com",
  "password": "password123"
}

# Delete user as ADMIN - expect 204
DELETE {{base}}/users/{{testUserId}}
Authorization: Basic admin admin123

### ===============================================================
### Avatars - upload/download/remove
### ===============================================================

# GET avatar (image)
GET {{base}}/users/{{testUserId}}/avatar
Accept: image/png, image/jpeg

# Upload JPG avatar (1.jpg)
POST {{base}}/users/{{testUserId}}/avatar
Content-Type: image/jpeg

< ./src/main/resources/avatars/1.jpg

# Upload PNG avatar (4.png)
POST {{base}}/users/{{testUserId}}/avatar
Content-Type: image/png

< ./src/main/resources/avatars/4.png

# Delete avatar
DELETE {{base}}/users/{{testUserId}}/avatar
Authorization: Basic test password123

### ===============================================================
### Smoke / negative tests
### ===============================================================

# Unauthenticated access -> should return 401
GET {{base}}/figures/
Accept: application/json

# USER tries to create figure -> should 403
POST {{base}}/figures/
Content-Type: application/json
Authorization: Basic test password123

{
  "name": "Forbidden Try",
  "dateOfBrith": "2000-01-01"
}

# ADMIN can create
POST {{base}}/figures/
Content-Type: application/json
Authorization: Basic admin admin123

{ "name": "Allowed by Admin" }

